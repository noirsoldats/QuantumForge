<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://images.evetech.net">
  <title>Manufacturing Plans - Quantum Forge</title>
  <link rel="stylesheet" href="manufacturing-plans.css">
</head>
<body>
  <div id="plans-app">
    <div class="plans-container">
      <!-- Left Panel - Plans List -->
      <div class="plans-sidebar">
        <div class="sidebar-header">
          <select id="character-selector" class="character-selector">
            <option value="">Loading characters...</option>
          </select>
          <button class="primary-button" id="create-plan-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            New Plan
          </button>
        </div>

        <input type="text" id="plan-search" class="search-input" placeholder="Search plans...">

        <div class="filter-section">
          <label><input type="radio" name="status-filter" value="all" checked> All</label>
          <label><input type="radio" name="status-filter" value="active"> Active</label>
          <label><input type="radio" name="status-filter" value="completed"> Completed</label>
          <label><input type="radio" name="status-filter" value="archived"> Archived</label>
        </div>

        <div id="plans-list" class="plans-list">
          <!-- Plans will be loaded here -->
        </div>
      </div>

      <!-- Right Panel - Plan Details -->
      <div class="plans-content">
        <div id="empty-state" class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 11l3 3L22 4"></path>
            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
          </svg>
          <h2>No Plan Selected</h2>
          <p>Select a plan from the list or create a new one</p>
        </div>

        <div id="plan-detail" class="plan-detail" style="display: none;">
          <!-- Plan Header -->
          <div class="plan-header">
            <div class="plan-info">
              <h2 id="plan-name" contenteditable="true">Plan Name</h2>
              <div class="plan-meta">
                <span id="plan-status" class="status-badge">Active</span>
                <span id="plan-created">Created: ...</span>
              </div>
            </div>
            <div class="plan-actions">
              <button class="secondary-button tooltip" id="refresh-current-view-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                Refresh
                <span class="tooltip-text">Refresh current view</span>
              </button>
              <button class="secondary-button" id="delete-plan-btn">Delete</button>
              <button class="secondary-button" id="complete-plan-btn">Mark Complete</button>
            </div>
          </div>

          <!-- Tabs -->
          <div class="tabs">
            <button class="tab-button active" data-tab="overview">Overview</button>
            <button class="tab-button" data-tab="blueprints">Blueprints</button>
            <button class="tab-button" data-tab="reactions" id="reactions-tab-button" style="display: none;">Reactions</button>
            <button class="tab-button" data-tab="materials">Materials</button>
            <button class="tab-button" data-tab="products">Products</button>
            <button class="tab-button" data-tab="jobs">Jobs</button>
            <button class="tab-button" data-tab="transactions">Transactions</button>
            <button class="tab-button" data-tab="analytics">Analytics</button>
            <button class="tab-button" data-tab="settings">Settings</button>
          </div>

          <!-- Tab Content -->
          <div class="tab-content">
            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-panel active">
              <div class="overview-grid">
                <div class="stat-card">
                  <h3>Material Cost</h3>
                  <div class="stat-value" id="overview-material-cost">0 ISK</div>
                  <div class="stat-meta" id="overview-material-meta">0/0 priced</div>
                </div>
                <div class="stat-card">
                  <h3>Product Value</h3>
                  <div class="stat-value" id="overview-product-value">0 ISK</div>
                  <div class="stat-meta" id="overview-product-meta">0/0 priced</div>
                </div>
                <div class="stat-card">
                  <h3>Estimated Profit</h3>
                  <div class="stat-value" id="overview-profit">0 ISK</div>
                  <div class="stat-meta" id="overview-roi">0% ROI</div>
                </div>
              </div>

              <div class="description-section">
                <h3>Description</h3>
                <textarea id="plan-description" class="description-input" placeholder="Add a description for this plan..."></textarea>
              </div>
            </div>

            <!-- Blueprints Tab -->
            <div id="blueprints-tab" class="tab-panel">
              <div class="tab-header">
                <h3>Blueprints in Plan</h3>
                <div class="blueprints-actions">
                  <button class="primary-button" id="add-blueprint-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Blueprint
                  </button>
                  <button class="secondary-button bulk-edit-control" id="bulk-edit-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    Bulk Edit
                  </button>
                  <button class="primary-button bulk-edit-control" id="bulk-save-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    Bulk Save
                  </button>
                  <button class="secondary-button bulk-edit-control" id="bulk-cancel-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    Cancel
                  </button>
                </div>
              </div>

              <!-- Bulk Edit Banner -->
              <div id="bulk-edit-banner" class="bulk-edit-banner" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="banner-icon">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                  <line x1="12" y1="9" x2="12" y2="13"></line>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span><strong>Bulk Edit Mode:</strong> Make changes to any blueprints below, then click Bulk Save to apply all changes.</span>
              </div>

              <div id="blueprints-list-tab" class="blueprints-table-container">
                <!-- Blueprints table will be loaded here -->
              </div>
            </div>

            <!-- Materials Tab -->
            <div id="materials-tab" class="tab-panel">
              <div class="tab-header">
                <h3>Shopping List</h3>
                <div class="tab-actions">
                  <label><input type="checkbox" id="include-assets-checkbox"> Show Owned</label>
                  <button class="secondary-button" id="refresh-prices-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                    Refresh Prices
                  </button>
                </div>
              </div>

              <!-- Warnings container for excess/removed acquisitions -->
              <div id="material-warnings" style="display:none;"></div>

              <div id="materials-list-tab" class="materials-table-container">
                <!-- Materials table will be loaded here -->
              </div>
            </div>

            <!-- Products Tab -->
            <div id="products-tab" class="tab-panel">
              <div class="tab-header">
                <h3>Expected Products</h3>
              </div>

              <div id="products-list-tab" class="products-table-container">
                <!-- Products table will be loaded here -->
              </div>
            </div>

            <!-- Reactions Tab -->
            <div id="reactions-tab" class="tab-panel">
              <div class="tab-header">
                <h3>Reactions</h3>
                <div class="tab-actions">
                  <button class="primary-button tooltip" id="save-reaction-facilities-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                      <polyline points="17 21 17 13 7 13 7 21"></polyline>
                      <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save Facilities
                    <span class="tooltip-text">Save all facility changes for reactions</span>
                  </button>
                  <button class="secondary-button tooltip" id="refresh-reaction-prices-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
                    </svg>
                    Refresh Prices
                    <span class="tooltip-text">Refresh market prices for all reaction materials</span>
                  </button>
                </div>
              </div>

              <div id="reactions-container">
                <div class="empty-state">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                  </svg>
                  <p>No reactions detected in this plan</p>
                  <p class="empty-state-hint">Reactions will appear here when blueprints require reaction products and 'Calculate Reactions as Intermediates' is enabled in Settings.</p>
                </div>
              </div>
            </div>

            <!-- Jobs Tab -->
            <div id="jobs-tab" class="tab-panel">
              <div class="tab-header">
                <h3>Industry Jobs</h3>
                <div class="tab-actions">
                  <button class="primary-button tooltip" id="match-jobs-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                    Match Jobs
                    <span class="tooltip-text">Find industry jobs from ESI that match blueprints in this plan</span>
                  </button>
                </div>
              </div>

              <div id="jobs-list-tab" class="jobs-table-container">
                <!-- Jobs matches will be loaded here -->
              </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions-tab" class="tab-panel">
              <div class="tab-header">
                <h3>Wallet Transactions</h3>
                <div class="tab-actions">
                  <button class="primary-button tooltip" id="match-transactions-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                    Match Transactions
                    <span class="tooltip-text">Find wallet transactions from ESI that match materials and products</span>
                  </button>
                </div>
              </div>

              <div id="transactions-list-tab" class="transactions-table-container">
                <!-- Transaction matches will be loaded here -->
              </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-panel">
              <div class="tab-header">
                <h3>Plan Analytics</h3>
                <div class="tab-actions">
                  <button class="secondary-button tooltip" id="refresh-esi-data-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                    Refresh ESI Data
                    <span class="tooltip-text">Manually fetch latest industry jobs and wallet transactions from ESI</span>
                  </button>
                </div>
              </div>

              <!-- Progress Section -->
              <div class="analytics-section">
                <h4>Progress</h4>
                <div class="progress-grid">
                  <div class="progress-card">
                    <div class="progress-label">Manufacturing Jobs</div>
                    <div class="progress-bar-container">
                      <div class="progress-bar" id="jobs-progress-bar"></div>
                    </div>
                    <div class="progress-text" id="jobs-progress-text">0 / 0 (0%)</div>
                  </div>
                  <div class="progress-card">
                    <div class="progress-label">Material Purchases</div>
                    <div class="progress-bar-container">
                      <div class="progress-bar" id="materials-progress-bar"></div>
                    </div>
                    <div class="progress-text" id="materials-progress-text">0 / 0 (0%)</div>
                  </div>
                  <div class="progress-card">
                    <div class="progress-label">Product Sales</div>
                    <div class="progress-bar-container">
                      <div class="progress-bar" id="products-progress-bar"></div>
                    </div>
                    <div class="progress-text" id="products-progress-text">0 / 0 (0%)</div>
                  </div>
                  <div class="progress-card">
                    <div class="progress-label">Overall Completion</div>
                    <div class="progress-bar-container">
                      <div class="progress-bar" id="overall-progress-bar"></div>
                    </div>
                    <div class="progress-text" id="overall-progress-text">0%</div>
                  </div>
                </div>
              </div>

              <!-- Planned vs Actual Section -->
              <div class="analytics-section">
                <h4>Planned vs Actual</h4>
                <div class="comparison-grid">
                  <div class="comparison-card">
                    <h5>Material Costs</h5>
                    <div class="comparison-row">
                      <span class="comparison-label">Planned:</span>
                      <span class="comparison-value" id="planned-material-cost">0 ISK</span>
                    </div>
                    <div class="comparison-row">
                      <span class="comparison-label">Actual:</span>
                      <span class="comparison-value" id="actual-material-cost">0 ISK</span>
                    </div>
                    <div class="comparison-row comparison-delta">
                      <span class="comparison-label">Difference:</span>
                      <span class="comparison-value" id="material-cost-delta">0 ISK (0%)</span>
                    </div>
                  </div>

                  <div class="comparison-card">
                    <h5>Product Value</h5>
                    <div class="comparison-row">
                      <span class="comparison-label">Planned:</span>
                      <span class="comparison-value" id="planned-product-value">0 ISK</span>
                    </div>
                    <div class="comparison-row">
                      <span class="comparison-label">Actual:</span>
                      <span class="comparison-value" id="actual-product-value">0 ISK</span>
                    </div>
                    <div class="comparison-row comparison-delta">
                      <span class="comparison-label">Difference:</span>
                      <span class="comparison-value" id="product-value-delta">0 ISK (0%)</span>
                    </div>
                  </div>

                  <div class="comparison-card">
                    <h5>Profit</h5>
                    <div class="comparison-row">
                      <span class="comparison-label">Planned:</span>
                      <span class="comparison-value" id="planned-profit">0 ISK</span>
                    </div>
                    <div class="comparison-row">
                      <span class="comparison-label">Actual:</span>
                      <span class="comparison-value" id="actual-profit">0 ISK</span>
                    </div>
                    <div class="comparison-row comparison-delta">
                      <span class="comparison-label">Difference:</span>
                      <span class="comparison-value" id="profit-delta">0 ISK (0%)</span>
                    </div>
                  </div>

                  <div class="comparison-card">
                    <h5>ROI</h5>
                    <div class="comparison-row">
                      <span class="comparison-label">Planned:</span>
                      <span class="comparison-value" id="planned-roi">0%</span>
                    </div>
                    <div class="comparison-row">
                      <span class="comparison-label">Actual:</span>
                      <span class="comparison-value" id="actual-roi">0%</span>
                    </div>
                    <div class="comparison-row comparison-delta">
                      <span class="comparison-label">Difference:</span>
                      <span class="comparison-value" id="roi-delta">0%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-panel">
              <div class="tab-header">
                <h3>Plan Settings</h3>
                <p class="tab-description">Configure plan-level overrides for industry settings</p>
              </div>

              <!-- Corporation Divisions Section -->
              <div class="settings-section">
                <h3>Corporation Divisions</h3>
                <p class="section-description">Select which corporation divisions to include for each character in this plan</p>
                <div id="plan-character-divisions-container"></div>
              </div>

              <!-- Default Manufacturing Characters Section -->
              <div class="settings-section">
                <h3>Plan Manufacturing Characters</h3>
                <p class="section-description">Select which characters are prioritized for this plan</p>
                <div id="plan-default-characters-container"></div>
              </div>

              <!-- Reactions Section -->
              <div class="settings-section">
                <h3>Reactions</h3>
                <p class="section-description">Configure how reactions are handled in manufacturing calculations for this plan</p>
                <div class="setting-item">
                  <div class="setting-info">
                    <label>Calculate Reactions as Intermediates</label>
                    <span class="setting-description">When enabled, reaction products will be calculated as intermediate materials rather than purchased from market</span>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" id="plan-reactions-as-intermediates">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Plan Modal -->
  <div id="create-plan-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create Manufacturing Plan</h2>
        <button class="close-btn" id="close-create-modal-btn">&times;</button>
      </div>
      <div class="modal-body">
        <label for="new-plan-name">Plan Name</label>
        <input type="text" id="new-plan-name" class="input-field" placeholder="Leave empty for auto-generated name">

        <label for="new-plan-description">Description (Optional)</label>
        <textarea id="new-plan-description" class="textarea-field" placeholder="Describe this manufacturing plan..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" id="cancel-create-btn">Cancel</button>
        <button class="primary-button" id="confirm-create-btn">Create Plan</button>
      </div>
    </div>
  </div>

  <!-- Add Blueprint Modal -->
  <div id="add-blueprint-modal" class="modal" style="display: none;">
    <div class="modal-content large">
      <div class="modal-header">
        <h2>Add Blueprint to Plan</h2>
        <button class="close-btn" id="close-blueprint-modal-btn">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" id="blueprint-search-modal" class="search-input" placeholder="Search blueprints from SDE...">
        <div id="blueprint-search-results" class="search-results">
          <!-- Search results will appear here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Configure Blueprint Modal -->
  <div id="configure-blueprint-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Configure Blueprint</h2>
        <button class="close-btn" id="close-configure-modal-btn">&times;</button>
      </div>
      <div class="modal-body">
        <h3 id="config-blueprint-name">Blueprint Name</h3>

        <label for="config-runs">Total Runs</label>
        <input type="number" id="config-runs" class="input-field" value="1" min="1">
        <span class="input-help">Total manufacturing runs to complete</span>

        <label for="config-lines">Production Lines</label>
        <input type="number" id="config-lines" class="input-field" value="1" min="1">
        <span class="input-help">Runs are split across lines (affects ME calculation)</span>

        <div id="runs-per-line-preview" class="config-preview">
          Runs per line: <span id="runs-per-line-value">1</span>
        </div>

        <label for="config-me">Material Efficiency (ME)</label>
        <input type="number" id="config-me" class="input-field" value="0" min="0" max="10">

        <label for="config-te">Time Efficiency (TE)</label>
        <input type="number" id="config-te" class="input-field" value="0" min="0" max="20">

        <label for="config-facility">Facility</label>
        <select id="config-facility" class="input-field">
          <option value="">No facility</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" id="cancel-configure-btn">Cancel</button>
        <button class="primary-button" id="confirm-configure-btn">Add to Plan</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Toast Notifications -->
  <div id="toast-container" class="toast-container"></div>

  <script src="../src/renderer/manufacturing-plans-renderer.js"></script>
</body>
</html>
